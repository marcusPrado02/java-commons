name: Backward Compatibility Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  compatibility-check:
    name: Check API Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build project
        run: ./mvnw -B clean package -DskipTests

      - name: Run JApiCmp compatibility check
        id: japicmp
        continue-on-error: true
        run: |
          # Run JApiCmp on each module that has a released version
          ./mvnw -B japicmp:cmp || echo "COMPATIBILITY_ISSUES=true" >> $GITHUB_OUTPUT

      - name: Upload JApiCmp reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: japicmp-reports
          path: |
            **/target/japicmp/
            **/target/japicmp-reports/
          retention-days: 30

      - name: Parse JApiCmp results
        if: steps.japicmp.outcome == 'failure'
        id: parse-results
        run: |
          # Extract compatibility issues from reports
          INCOMPATIBILITIES=$(find . -name "japicmp.html" -exec grep -l "binary incompatible" {} \; | wc -l)
          echo "count=$INCOMPATIBILITIES" >> $GITHUB_OUTPUT

          # Create summary
          echo "### ⚠️ Backward Compatibility Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Found $INCOMPATIBILITIES module(s) with binary incompatible changes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the JApiCmp reports in the workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: steps.japicmp.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const incompatibilities = '${{ steps.parse-results.outputs.count }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⚠️ Backward Compatibility Check

              This PR introduces **${incompatibilities}** module(s) with binary incompatible changes.

              ### What does this mean?
              Binary incompatible changes break existing code that depends on this library. These changes require a **MAJOR** version bump according to [Semantic Versioning](https://semver.org/).

              ### Common incompatible changes:
              - Removing public classes, methods, or fields
              - Changing method signatures
              - Changing field types
              - Making classes or methods final
              - Reducing visibility (public → protected/private)

              ### Actions required:
              1. Review the JApiCmp compatibility reports in the workflow artifacts
              2. Either:
                 - Revert the incompatible changes, OR
                 - Ensure this will be released as a major version bump
                 - Update CHANGELOG.md with \`BREAKING CHANGE:\` notices

              ### View detailed reports
              Download the \`japicmp-reports\` artifact from the workflow run to see detailed compatibility analysis.

              ---

              ℹ️ If these breaking changes are intentional and this PR is for a major release, you can ignore this warning.`
            })

      - name: Fail if incompatible changes detected
        if: steps.japicmp.outcome == 'failure'
        run: |
          echo "::error::Binary incompatible changes detected. See JApiCmp reports for details."
          exit 1

  semver-check:
    name: Semantic Versioning Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version bump type
        if: github.event_name == 'pull_request'
        run: |
          # Extract commit messages from PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          COMMITS=$(git log --pretty=format:"%s" ${BASE_SHA}..${HEAD_SHA})

          # Check for breaking changes
          if echo "$COMMITS" | grep -qE "^[a-z]+(\([a-z]+\))?!:|BREAKING CHANGE:"; then
            echo "✅ Breaking changes detected - requires MAJOR version bump"
            echo "REQUIRED_BUMP=major" >> $GITHUB_ENV
          elif echo "$COMMITS" | grep -qE "^feat"; then
            echo "✅ New features detected - requires MINOR version bump"
            echo "REQUIRED_BUMP=minor" >> $GITHUB_ENV
          elif echo "$COMMITS" | grep -qE "^fix"; then
            echo "✅ Bug fixes detected - requires PATCH version bump"
            echo "REQUIRED_BUMP=patch" >> $GITHUB_ENV
          else
            echo "ℹ️ No version-impacting changes detected"
            echo "REQUIRED_BUMP=none" >> $GITHUB_ENV
          fi

          echo "### Semantic Versioning Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required version bump:** \`${{ env.REQUIRED_BUMP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Commits analyzed:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$COMMITS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
